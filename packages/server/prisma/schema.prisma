generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// 用户
model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  displayName  String?
  avatar       String?
  settings     String?   @default("{}")
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  
  libraries    Library[]
  pages        Page[]
  templates    Template[]
}

// 知识库
model Library {
  id          String    @id @default(uuid())
  title       String
  description String?
  content     String    // 富文本内容（JSON 格式）
  icon        String?
  sortOrder   Int       @default(0)
  isPublic    Boolean   @default(false)
  publicSlug  String?   @unique
  metadata    String?   @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  pages       Page[]
  
  @@index([userId])
}

// 页面
model Page {
  id          String    @id @default(uuid())
  title       String
  content     String    // 富文本内容（JSON 格式）
  icon        String?
  coverImage  String?
  isPublic    Boolean   @default(false)
  publicSlug  String?   @unique
  sortOrder   Int       @default(0)
  metadata    String?   @default("{}")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastViewedAt DateTime?
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  libraryId   String
  library     Library   @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  
  parentId    String?
  parent      Page?     @relation("PageHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    Page[]    @relation("PageHierarchy")
  
  versions    PageVersion[]
  tasks       Task[]
  tags        PageTag[]
  
  // 页面引用关系
  outgoingRefs PageReference[] @relation("SourcePage")
  incomingRefs PageReference[] @relation("TargetPage")
  
  @@index([userId])
  @@index([libraryId])
  @@index([parentId])
  @@index([isPublic])
}

// 页面版本
model PageVersion {
  id          String    @id @default(uuid())
  content     String
  message     String?
  createdAt   DateTime  @default(now())
  
  pageId      String
  page        Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  @@index([pageId])
}

// 页面引用关系
model PageReference {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  
  sourceId    String
  source      Page      @relation("SourcePage", fields: [sourceId], references: [id], onDelete: Cascade)
  
  targetId    String
  target      Page      @relation("TargetPage", fields: [targetId], references: [id], onDelete: Cascade)
  
  @@unique([sourceId, targetId])
  @@index([sourceId])
  @@index([targetId])
}

// 标签
model Tag {
  id          String    @id @default(uuid())
  name        String    @unique
  color       String?
  createdAt   DateTime  @default(now())
  
  pages       PageTag[]
}

// 页面-标签关联
model PageTag {
  pageId      String
  page        Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  tagId       String
  tag         Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([pageId, tagId])
}

// 任务
model Task {
  id          String    @id @default(uuid())
  content     String
  isCompleted Boolean   @default(false)
  dueDate     DateTime?
  sortOrder   Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?
  
  pageId      String
  page        Page      @relation(fields: [pageId], references: [id], onDelete: Cascade)
  
  @@index([pageId])
  @@index([isCompleted])
  @@index([dueDate])
}

// 模板
model Template {
  id          String    @id @default(uuid())
  title       String
  description String?
  content     String
  category    String?
  isBuiltIn   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  userId      String?
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  
  @@index([userId])
  @@index([category])
}

// 系统配置
model SystemConfig {
  key         String    @id
  value       String
  updatedAt   DateTime  @updatedAt
}
